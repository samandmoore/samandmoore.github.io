---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("posts")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// Group posts by year
const postsByYear = posts.reduce(
  (acc, post) => {
    const year = post.data.date.getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof posts>
);

const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<BaseLayout title="Archive">
  <section class="Archive-section">
    {
      years.map((year) => (
        <>
          <h2>{year}</h2>
          {postsByYear[year].map((post) => (
            <article>
              <h1>
                <a href={`/posts/${post.id}`}>{post.data.title}</a>
              </h1>
              <time datetime={post.data.date.toISOString()}>
                <span class="month">
                  {post.data.date.toLocaleDateString("en-US", {
                    month: "short",
                  })}
                </span>{" "}
                <span class="day">{post.data.date.getDate()}</span>{" "}
                <span class="year">{post.data.date.getFullYear()}</span>
              </time>
              {post.data.tags && post.data.tags.length > 0 && (
                <footer>
                  <span class="categories">
                    posted in{" "}
                    {post.data.tags.map((tag, i) => (
                      <>
                        <a href={`/tags/${tag}`}>{tag}</a>
                        {i < post.data.tags!.length - 1 && " "}
                      </>
                    ))}
                  </span>
                </footer>
              )}
            </article>
          ))}
        </>
      ))
    }
  </section>
</BaseLayout>
